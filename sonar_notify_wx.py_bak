#!/usr/bin/python
#_*_coding:utf-8 _*_

import requests,sys,json,os
requests.packages.urllib3.disable_warnings()
reload(sys)
sys.setdefaultencoding('utf-8')

#è·å–Token
def GetToken(Corpid,Secret):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/gettoken"
    Data = {
        "corpid": Corpid,
        "corpsecret": Secret
    }
    r = requests.get(url=Url,params=Data,verify=False)
    Token = r.json()['access_token']
    return Token

#å°†è·å–åˆ°çš„è¶‹åŠ¿å›¾ï¼Œä¸Šä¼ è‡³ä¼ä¸šå¾®ä¿¡ä¸´æ—¶ç´ æï¼Œè¿”å›MediaIdå‘é€å›¾æ–‡æ¶ˆæ¯æ˜¯ä½¿ç”¨
def GetImageUrl(Token,Path):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/media/upload?access_token=%s&type=image" % Token
    data = {
        "media": open(Path,'r')
        }
    r = requests.post(url=Url,files=data)
    dict = r.json()
    return dict['media_id']

#æ–‡æœ¬æ¶ˆæ¯
def SendTextMessage(Token,User,Agentid,Content):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s" % Token
    Data = {
        "touser": User,                                 # ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·
        "msgtype": "text",                          # æ¶ˆæ¯ç±»å‹
        "agentid": Agentid,                             # ä¼ä¸šå·ä¸­çš„åº”ç”¨id
        "text": {
            "content": Content
        },
    "safe": "0"
    }
    r = requests.post(url=Url,data=json.dumps(Data),verify=False)
    return r.text


#å¡ç‰‡æ¶ˆæ¯
def SendCardMessage(Token,User,Agentid,Subject,Content,Detail_url):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s" % Token
    Data = {
        "touser": User,                                 # ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·
        "msgtype": "textcard",                          # æ¶ˆæ¯ç±»å‹
        "agentid": Agentid,                             # ä¼ä¸šå·ä¸­çš„åº”ç”¨id
        "textcard": {
            "title": Subject,
            "description": Content,
            "url": Detail_url,          #ç‚¹å‡»è¯¦æƒ…åæ‰“å¼€çš„é¡µé¢
            "btntxt": "ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"
        },
    "safe": "0"
    }
    r = requests.post(url=Url,data=json.dumps(Data),verify=False)
    return r.text

#å›¾æ–‡æ¶ˆæ¯news
def SendnewsMessage(Token,User,Agentid,Subject,Content,History_url,Pic_url):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s" % Token
    Data = {
            "touser": User,                                 # ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·
            "msgtype": "news",                            # æ¶ˆæ¯ç±»å‹
            "agentid": Agentid,                             # ä¼ä¸šå·ä¸­çš„åº”ç”¨id
            "news": {
                    "articles": [
                    {
                            "title": Subject,
                            "description": Content,
                            "picurl": Pic_url,
                            "url": History_url,      #ç‚¹å‡»é˜…è¯»åŸæ–‡åï¼Œæ‰“å¼€è¶‹åŠ¿å›¾å¤§å›¾ï¼Œç¬¬ä¸€æ¬¡éœ€è¦ç™»å½•
                    }
                    ]
            },
            "safe": "0"
    }
    headers = {'content-type': 'application/json'}
    data = json.dumps(Data,ensure_ascii=False).encode('utf-8')
    r = requests.post(url=Url,headers=headers,data=data)
    return r.text

#å›¾æ–‡æ¶ˆæ¯mpnews
def SendmpnewsMessage(Token,User,Agentid,Subject,Content,Media_id,history_url):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s" % Token
    Data = {
            "touser": User,                                 # ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·
            "msgtype": "mpnews",                            # æ¶ˆæ¯ç±»å‹
            "agentid": Agentid,                             # ä¼ä¸šå·ä¸­çš„åº”ç”¨id
            "mpnews": {
                    "articles": [
                    {
                            "title": Subject,
                            "thumb_media_id": Media_id,
                            "content": Content,
                            "content_source_url": history_url,      #ç‚¹å‡»é˜…è¯»åŸæ–‡åï¼Œæ‰“å¼€è¶‹åŠ¿å›¾å¤§å›¾ï¼Œç¬¬ä¸€æ¬¡éœ€è¦ç™»å½•
                            "digest": Content,
                            "show_cover_pic": "1"
                    }
                    ]
            },
            "safe": "1"
    }
    headers = {'content-type': 'application/json'}
    data = json.dumps(Data,ensure_ascii=False).encode('utf-8')
    r = requests.post(url=Url,headers=headers,data=data)
    return r.text

#æäº¤å®¡æ‰¹
def SendApproval(Token,Creator_userid, Template_id, Project_name, Branch_name, Branch_commit, Image_name, Image_tag, Option_id, Platform_type):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/oa/applyevent?access_token=%s" % Token
    Data = {
    	"creator_userid": Creator_userid,
    	"template_id": Template_id,
    	"use_template_approver": 1,
    	#"approver": [
    	#    {
    	#        "attr": 2,
    	#        "userid": ["WuJunJie","WangXiaoMing"]
    	#    },
    	#    {
    	#        "attr": 1,
    	#        "userid": ["LiuXiaoGang"]
    	#    }
    	#],
    	#"notifyer":[ "WuJunJie","WangXiaoMing" ],
    	#"notify_type" : 1,
    	"apply_data": {
    	    "contents":[
                {
    	            "control": "Text",
    	            "id": "Text-1581492024088",
    	            "title": [
    	                {
    	                    "text": "é¡¹ç›®åç§°",
    	                    "lang": "zh_CN"
    	                }
    	            ],
    	            "value": {
    	                "text": Project_name.strip()
    	            }
    	        },
    	        {
    	           "control": "Selector",
    	           "id": "Selector-1581492416321",
    	           "title": [
    	               {
    	                   "text": "å‘å¸ƒç¯å¢ƒ",
    	                   "lang": "zh_CN"
    	               }
    	           ],
    	           "value": {
                       "selector": {
	           	"type": "single",
                             "options": [
                                  {
                                      "key": Option_id
                                  }
                              ]
	               }
    	           }
    	        },
    	        {
    	           "control": "Text",
    	           "id": "Text-1581492549750",
    	           "title": [
    	               {
    	                   "text": "ä»£ç åˆ†æ”¯",
    	                   "lang": "zh_CN"
    	               }
    	           ],
    	           "value": {
    	               "text": Branch_name.strip()
    	           }
    	        },
    	        {
    	           "control": "Text",
    	           "id": "Text-1581492572185",
    	           "title": [
    	               {
    	                   "text": "Commit",
    	                   "lang": "zh_CN"
    	               }
    	           ],
    	           "value": {
    	               "text": Branch_commit.strip()
    	           }
    	        },
    	        {
    	           "control": "Text",
    	           "id": "Text-1581492656710",
    	           "title": [
    	               {
    	                   "text": "é•œåƒåç§°",
    	                   "lang": "zh_CN"
    	               }
    	           ],
    	           "value": {
    	               "text": Image_name.strip()
    	           }
    	        },
    	        {
    	           "control": "Text",
    	           "id": "Text-1581492696732",
    	           "title": [
    	               {
    	                   "text": "é•œåƒtag",
    	                   "lang": "zh_CN"
    	               }
    	           ],
    	           "value": {
    	               "text": Image_tag.strip()
    	           }
    	        }
            ]
        },
         "summary_list": [
            {
                "summary_info": [{
                    "text": "é¡¹ç›®åç§°: %s" %Project_name ,
                    "lang": "zh_CN"
                }]
            },
            {
                "summary_info": [{
                    "text": "å‘å¸ƒç¯å¢ƒ: %s" %Platform_type ,
                    "lang": "zh_CN"
                }]
            },
            { "summary_info": [{
                    "text": "é•œåƒåç§°: %s:%s" %(Image_name, Image_tag),
                    "lang": "zh_CN"
                }]
            }

        ]
    }

    r = requests.post(url=Url,data=json.dumps(Data),verify=False)
    return r.text

#è·å–å®¡æ‰¹æ¨¡æ¿è¯¦æƒ…
def GetTemplateDetail(Token, Template_id):
    Url = "https://qyapi.weixin.qq.com/cgi-bin/oa/gettemplatedetail?access_token=%s" % Token
    Data = {
        "template_id": Template_id
    }
    r = requests.post(url=Url,data=json.dumps(Data),verify=False)
    return r.text

#è§£æsonarqubeæ‰«æç»“æœ
def SonarqubeDetail(sonar_url, project_name):
    api_url = sonar_url + "/api/measures/search?projectKeys=" + project_name + "&metricKeys=alert_status%2Cbugs%2Creliability_rating%2Cvulnerabilities%2Csecurity_rating%2Ccode_smells%2Csqale_rating%2Cduplicated_lines_density%2Ccoverage%2Cncloc%2Cncloc_language_distribution"
    # è·å–sonaræŒ‡å®šé¡¹ç›®ç»“æœ
    resopnse = requests.get(api_url).text
    # è½¬æ¢æˆjosn
    result = json.loads(resopnse)
    bug = 0
    leak = 0
    code_smell = 0
    coverage = 0
    density = 0
    security = 0
    
    status = ''
    statusStr = ''

# è§£æsonar jsonç»“æœ
    for item in result['measures']:
        #bug
        if item['metric'] == "bugs":
            bug = item['value'].strip()
        #æ¼æ´æ•°
        elif item['metric'] == "vulnerabilities":
            leak = item['value'].strip()
        #å¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°
        elif item['metric'] == 'code_smells':
            code_smell = item['value'].strip()
        #è¦†ç›–ç‡
        elif item['metric'] == 'coverage':
            coverage = item['value'].strip()
        #é‡å¤ç‡
        elif item['metric'] == 'duplicated_lines_density':
            density = item['value'].strip()
        #å®‰å…¨æ¼æ´
        elif item['metric'] == 'security_rating':
            security = item['value'].strip()
        #çŠ¶æ€
        elif item['metric'] == 'alert_status':
            status = item['value'].strip()
    return status, bug, leak, code_smell, security, coverage, density

if __name__ == "__main__":
    Corpid = sys.argv[1]
    Secret = sys.argv[2]
    Agent_id = sys.argv[3]
    To_user = sys.argv[4]
    Repo_name = sys.argv[5]
    Branch_name = sys.argv[6]
    Build_num = sys.argv[7]
    Sonar_url = sys.argv[8]

    Token = GetToken(Corpid,Secret)
    Detail_url = '%s/dashboard?id=%s' %(Sonar_url, Repo_name)
    status, bug, leak, code_smell, security, coverage, density = SonarqubeDetail(Sonar_url, Repo_name)

    # åˆ¤æ–­æ–°ä»£ç è´¨é‡é˜€çŠ¶æ€
    title = ''
    description = ''
    if status == 'OK':
        title = "âœ…æ­å–œ, ä»£ç [%s]-åˆ†æ”¯[%s]#%s æ‰«æé€šè¿‡~ğŸ‘" %(Repo_name, Branch_name, Build_num)
        description = """
Bugæ•°: <div class=\"highlight\">%s ä¸ª</div><br>
æ¼æ´æ•°: <div class=\"highlight\">%s ä¸ª</div><br>
å¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: <div class=\"highlight\">%s è¡Œ</div><br>
å®‰å…¨æ¼æ´: <div class=\"highlight\">%s ä¸ª</div><br>
è¦†ç›–ç‡: <div class=\"highlight\">%s%%</div><br>
é‡å¤ç‡: <div class=\"highlight\">%s%%</div>
""" %(bug, leak, code_smell, security, coverage, density)
        print "ä»£ç æ‰«ææˆåŠŸï¼ï¼ï¼"
        res = SendCardMessage(Token, To_user, Agent_id, title, description, Detail_url)
        res_dict = json.loads(res)
        if res_dict['errcode'] == 0:
            print 'Send Message success!!!'
            print 'Status: %s \nBugæ•°: %s \næ¼æ´æ•°: %s \nå¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: %s \nå®‰å…¨æ¼æ´: %s \nè¦†ç›–ç‡: %s \né‡å¤ç‡: %s' %(status,bug, leak, code_smell, security, coverage, density)
        else:
            print 'Send Approval error!!! Detail: %s' %res_dict
            print 'Status: %s \nBugæ•°: %s \næ¼æ´æ•°: %s \nå¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: %s \nå®‰å…¨æ¼æ´: %s \nè¦†ç›–ç‡: %s \né‡å¤ç‡: %s' %(status,bug, leak, code_smell, security, coverage, density)
            sys.exit(1)

    elif status == 'ERROR':
        title = "âŒçœŸé—æ†¾, ä»£ç [%s]-åˆ†æ”¯[%s]#%s æ‰«ææœªé€šè¿‡~ğŸ˜­" %(Repo_name, Branch_name, Build_num)
        description = """
Bugæ•°: <div class=\"highlight\">%s ä¸ª</div><br>
æ¼æ´æ•°: <div class=\"highlight\">%s ä¸ª</div><br>
å¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: <div class=\"highlight\">%s è¡Œ</div><br>
å®‰å…¨æ¼æ´: <div class=\"highlight\">%s ä¸ª</div><br>
è¦†ç›–ç‡: <div class=\"highlight\">%s%%</div><br>
é‡å¤ç‡: <div class=\"highlight\">%s%%</div>
""" %(bug, leak, code_smell, security, coverage, density)

        print "ä»£ç æ‰«æå¤±è´¥ï¼ï¼ï¼è¯·ä¿®æ”¹åä»£ç é‡æ–°æäº¤æ„å»º!!!!"
        res = SendCardMessage(Token, To_user, Agent_id, title, description, Detail_url)
        res_dict = json.loads(res)
        if res_dict['errcode'] == 0:
            print 'Send Message success!!!'
            print 'Status: %s \nBugæ•°: %s \næ¼æ´æ•°: %s \nå¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: %s \nå®‰å…¨æ¼æ´: %s \nè¦†ç›–ç‡: %s \né‡å¤ç‡: %s' %(status,bug, leak, code_smell, security, coverage, density)
            sys.exit(1)
        else:
            print 'Send Approval error!!! Detail: %s' %res_dict
            print 'Status: %s \nBugæ•°: %s \næ¼æ´æ•°: %s \nå¯èƒ½å­˜åœ¨é—®é¢˜ä»£ç è¡Œæ•°: %s \nå®‰å…¨æ¼æ´: %s \nè¦†ç›–ç‡: %s \né‡å¤ç‡: %s' %(status,bug, leak, code_smell, security, coverage, density)
            sys.exit(1)

